# Scan with Trivy
.container_scanning:
  stage: test
  image:
    name: aquasec/trivy:0.12.0
    entrypoint: [""]

  allow_failure: true
  interruptible: true
  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_DRIVER: overlay2
    # See https://github.com/docker-library/docker/pull/166
    DOCKER_TLS_CERTDIR: ""
    CI_APPLICATION_REPOSITORY: "$CI_REGISTRY_IMAGE$SUB_IMAGE_NAME"
    CI_APPLICATION_TAG: "${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
    TRIVY_USERNAME: "$CI_REGISTRY_USER"
    TRIVY_PASSWORD: "$CI_REGISTRY_PASSWORD"
    TRIVY_AUTH_URL: "$CI_REGISTRY"
    TRIVY_SEVERITY: "HIGH,CRITICAL"
  services:
    - name: docker:stable-dind
      entrypoint: ["env", "-u", "DOCKER_HOST"]
      command: ["dockerd-entrypoint.sh"]
  script:
    - '###'
    - '### Documentation: @TODO ###'
    - '###'
    - trivy --version
    - echo "# scanning ${CI_APPLICATION_REPOSITORY}:${CI_APPLICATION_TAG}"
    - trivy client --exit-code 0 --quiet ${CI_APPLICATION_REPOSITORY}:${CI_APPLICATION_TAG} > trivy_container_report.txt
    - trivy client --exit-code 0 --quiet  --format template --template "@/contrib/junit.tpl" -o trivy_container_report.xml "${CI_APPLICATION_REPOSITORY}:${CI_APPLICATION_TAG}"
    - trivy client --exit-code 1 --quiet ${CI_APPLICATION_REPOSITORY}:${CI_APPLICATION_TAG}
  cache: {}
  artifacts:
    when: always
    expire_in: 6 mos
    paths:
      - trivy_container_report.txt
      - ./trivy_container_report.xml
    reports:
      junit: ./trivy_container_report.xml
  dependencies: []
  only:
    refs:
      - branches
  except:
    variables:
      - $CONTAINER_SCANNING_DISABLED
