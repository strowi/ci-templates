#
# Check if gpg-keys in .git-crypt belong to gitlab-users
#
scan:gpg_keys:
  stage: test
  image: strowi/deploy
  interruptible: true
  allow_failure: true
  cache: {}
  needs: []
  dependencies: []
  rules:
    - if: '$GPGCHECK_DISABLED'
      when: never
    - if: '$CI_COMMIT_TAG || $CI_COMMIT_BRANCH'
      exists:
        - .git-crypt/**/**/**/*gpg
      when: always
    - when: never
  variables:
    GPG_USERS_PATH: /tmp/gpg_keys
  script:
    - '###'
    - '### Scanning .git-crypt for non-existing keys...'
    - '### Documentation: https://git.chefkoch.net/sys/ci/templates/-/blob/master/docs/tests_gpg-keys.md ###'
    - '###'
    - git clone --depth 1 https://gitlab-ci-token:${CI_JOB_TOKEN}@git.chefkoch.net/sys/gpg_keys.git /tmp/gpg_keys
    - gpg --import $GPG_USERS_PATH/users/*gpg
    - /tmp/gpg_keys/bin/check_keys.sh
