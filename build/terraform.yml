variables:
  SNAP_USER_COMMON: ${CI_PROJECT_DIR}
  PLAN: plan.tfplan
  PLAN_JSON: tfplan.json
  TERRAFORM_TAG: latest

image:
  name: "registry.gitlab.com/strowi/terraform:latest"
  entrypoint:
    - '/usr/bin/env'
    - 'PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'


# terraform init with ci user/pass + convert report alias
.tf: &tf |
  function tfi(){
    cd ${TF_ROOT}
    tfswitch
    terraform --version
    terraform init \
    -backend-config=username="gitlab-ci-token"  \
    -backend-config=password="${CI_JOB_TOKEN}" \
    -reconfigure
  }
  alias convert_report="jq -r '([.resource_changes[]?.change.actions?]|flatten)|{\"create\":(map(select(.==\"create\"))|length),\"update\":(map(select(.==\"update\"))|length),\"delete\":(map(select(.==\"delete\"))|length)}'"
  function tfdocs() {
    for d in $TF_ROOT_DIRS; do
      terraform-docs md ./$d > ./$d/readme.md
      if [ $? -eq 0 ] ; then
        git add "./$d/readme.md"
      fi
    done
    for d in modules/*; do
      test -d ./$d && terraform-docs md ./$d > ./$d/readme.md
      if [ $? -eq 0 ] ; then
        git add "./$d/readme.md"
      fi
    done
  }

# ref: https://gitlab.com/infracost/infracost-gitlab-ci/
.infracost:
  script: "/scripts/ci/diff.sh" # Do not change
  variables:
    # Path to the Terraform directory or JSON/plan file. Either `path` or `config_file` is required.
    path: "${TF_ROOT}/${PLAN}"
    #
    # Flags to pass to the 'terraform plan' command, e.g. `"-var-file=my.tfvars -var-file=other.tfvars"`. Applicable when path is a Terraform directory.
    # terraform_plan_flags:
    #
    # The Terraform workspace to use. Applicable when path is a Terraform directory. Only set this for multi-workspace deployments, otherwise it might result in the Terraform error "workspaces not supported".
    # terraform_workspace:
    #
    # Path to Infracost usage file (https://www.infracost.io/docs/usage_based_resources) that specifies values for usage-based resources, see https://github.com/infracost/infracost/blob/master/infracost-usage-example.yml for the available options.
    # usage_file:
    #
    # If your repo has multiple Terraform projects or workspaces, define them in a config file (https://www.infracost.io/docs/config_file/) and set this input to its path. Their results will be combined into the same diff output. Cannot be used with path, terraform_plan_flags or usage_file inputs.
    # config_file:
    #
    # Show unsupported resources, some of which might be free, at the bottom of the Infracost output (default is false).
    # show_skipped:
    #
    # A JSON string describing the condition that triggers pull request comments, can be one of these:
    #  - `'{"has_diff": true}'`: only post a comment if there is a diff. This is the default behavior.
    #  - `'{"always": true}'`: always post a comment.
    #  - `'{"percentage_threshold": 0}'`: absolute percentage threshold that triggers a comment. For example, set to 1 to post a comment if the cost estimate changes by more than plus or minus 1%.
    post_condition: '{"has_diff": true}'



before_script:
  - mkdir -p ~/.ssh && ssh-keyscan -p 22 gitlab.com > ~/.ssh/known_hosts
  - eval "$(ssh-agent -s)"
  - echo "$CI_SSH_PRIVATE_KEY" | base64 -d | ssh-add - >/dev/null || echo "no ssh key specified"
  - echo "$CI_GPG_PRIVATE_KEY" | base64 -d | gpg --import && crypt unlock || echo "no gpg key specified"
  - *tf

.fmt:
  stage: format
  script:
    - git config --global user.email "ci@hasnoname.de"
    - git config --global user.name "ci"
    - git checkout $CI_COMMIT_REF_NAME
    - git remote rm origin && git remote add origin "ssh://git@gitlab.com:/${CI_PROJECT_PATH}.git"
    - terraform fmt -check -recursive ./ || ( terraform fmt -recursive ./  && git commit -m "[ci] Terraform formatting" . )
    - tfdocs
    - git commit -m "[ci] Terraform docs" . || true
    - git push --set-upstream origin $CI_COMMIT_REF_NAME -o ci.skip
  rules:
    - if: $CI_SSH_PRIVATE_KEY == null
      when: never
    - if: $CI_COMMIT_BRANCH
      when: always

.checkov:
  stage: validate
  image:
    # TODO: mirror image
    name: bridgecrew/checkov:2.0.405
    entrypoint:
      - '/usr/bin/env'
      - 'PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'
  allow_failure: true
  needs: []
  cache:
    key: "${TF_ROOT}-${CI_COMMIT_REF_SLUG}"
    paths:
      - ${TF_ROOT}/.terraform
      - .terraform.versions
  artifacts:
    when: always
    reports:
      junit: $TF_ROOT/checkov.xml
  before_script: []
  script:
    - cd ${TF_ROOT}
    - '#'
    - '# https:fi//github.com/bridgecrewio/checkov'
    - '#'
    - checkov -s -d .
    - checkov -d . -o junitxml > checkov.xml

.plan:
  stage: plan
  allow_failure: false
  cache:
    key: "${TF_ROOT}-${CI_COMMIT_REF_SLUG}"
    paths:
      - ${TF_ROOT}/.terraform
      - .terraform.versions
  artifacts:
    name: ${TF_ROOT}
    when: always
    paths:
      - $TF_ROOT/$PLAN
    reports:
      terraform: $TF_ROOT/$PLAN_JSON
  script:
    - tfi
    - terraform validate
    - terraform plan -out=$PLAN
    - alias convert_report="jq -r '([.resource_changes[]?.change.actions?]|flatten)|{\"create\":(map(select(.==\"create\"))|length),\"update\":(map(select(.==\"update\"))|length),\"delete\":(map(select(.==\"delete\"))|length)}'"
    - terraform show --json $PLAN | convert_report > $PLAN_JSON

.deploy:
  stage: apply
  script:
    - tfi
    - terraform apply -auto-approve
  dependencies:
    - plan
  cache:
    key: "${TF_ROOT}-${CI_COMMIT_REF_SLUG}"
    paths:
      - ${TF_ROOT}/.terraform
      - .terraform.versions
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: manual
    - when: never
